//###################################################################################################
// Create Function

module.exports.create = function(_events, _config) {
    return new Handler(_events, _config);
};

//###################################################################################################
// Basic Object
function Handler(_events, _config) {
    /////////////////////////////////////////////////////////////////////////////////////////////////
   
    var 
    ////=============================================================================================
    // Requirements
        
        xmpp = require('node-xmpp'),
        util = require('util'),
    
    ////=============================================================================================
    // Propertys

        name = 'xmpp',
        self = this,
        events,
        xmppServer,
        config,
        presence, 
    
    ////=============================================================================================
    // Methods
    
        ////-----------------------------------------------------------------------------------------
        // Initialize
        init = function(_events, _config) {
            if( _events !== undefined )
                events = _events;
            else
                console.error('['+name+']EventEmitter undefined');
            
            if( _config !== undefined )
                config = _config;
            else
                events.emit('error', name, 'Options undefined');
            
            xmppServer = new xmpp.Client( {
                jid     :config.jid,
                password:config.password,
                host    :config.host,
                port    :config.port
            });

            presence = new xmpp.Element('presence', {});
            presence.c('show').t('chat').up().c('status').t('Here for your service');
            
            // Events
            xmppServer.on('online', onOnline);
            xmppServer.on('error', onError);       
            xmppServer.on('stanza', onStanza);
            
            // Actions
            events.on(name, onEvent);

        },

        ////-----------------------------------------------------------------------------------------
        //  When the client is Ready and online, show presence
        onOnline = function() {
            xmppServer.send(presence);
            
            // Request the Rooster
            var iq = new xmpp.Element('iq', {type:'get', id: 'i2xreq'});
            iq.c('query', {'xmlns': 'jabber:iq:roster'});
            xmppServer.send(iq);
        },
        
        ////-----------------------------------------------------------------------------------------
        // If an error occurs
        onError = function(error) {
            console.log('ERROR: '+util.inspect(error));
        },
        
        ////-----------------------------------------------------------------------------------------
        // Stanza ( abstract message from server ) arrives // http://xmpp.org/rfcs/rfc6121.html
        onStanza = function(stanza) {
            try {
                if(stanza.attrs.type === 'error') {
                    events.emit('xmpp', 'error', 'stanza error');
                    onError('Stanza Error');
                }
                         
                // Retrieve the rooster on connect ( or request )
                if( stanza.name === 'iq' ) {
                }
                         
                // Message from one of the clients
                if (stanza.name === 'message') {
                    for(var child in stanza.children) {
                        if( stanza.children[child].name !== undefined ) {
                            if( stanza.children[child].name ==='body' ) {   
                                var body = stanza.children[child];
                                    
                                for(var item in body.children) {
                                    var message = body.children[item];
                                    
                                    if( message.charAt(0) === '!')
                                        events.emit('xmpp', 'command', stanza.attrs.from, stanza.attrs.to, message);                    
                                    else
                                        events.emit('xmpp', 'message', stanza.attrs.from, stanza.attrs.to, message);
                                }
                            }
                        }
                    }        
                }  
                     
                // Presence event
                if( stanza.is('presence')) {
                    
                    if( stanza.attrs.type === undefined ) {
                        events.emit('xmpp','online', stanza.attrs.from);
                    }
                    else if ( stanza.attrs.type === 'unavailable') {
                        events.emit('xmpp','offline', stanza.attrs.from);
                    }
                    else if( stanza.attrs.type === 'subscribe' ) {       
                        events.emit('xmpp','subscribe', stanza.attrs.from);
                    }
                    else if( stanza.attrs.type === 'unsubscribe') {
                        events.emit('xmpp','unsubscribe', stanza.attrs.from);   
                    }
                    else {
                        events.emit('xmpp','presence', stanza.attrs.from, stanza.attrs.to, stanza);
                    }
                }
            }
            catch( err )
            {
                console.log('ERROR: '+util.inspect(err)+'\nStanza: '+util.inspect(stanza));
            }
        },
                
        ////-----------------------------------------------------------------------------------------
        // Decide which function should handle the event
        onEvent = function(type) {
            try {
                var args = Array.prototype.slice.call(arguments, 1);
            
                switch(type) {
                case 'send':
                    send.apply(this,args);
                    break;
                case 'dosubscribe':
                    dosubscribe.apply(this,args);
                    break;
                case 'dounsubscribe':
                    dounsubscribe.apply(this,args);
                    break;    
                case 'subscribed':
                    subscribed.apply(this,args);
                    break;
                case 'unsubscribed':
                    unsubscribed.apply(this,args);
                    break;
                }
            }
            catch( err )
            {
                events.emit(name, 'error', err);
            }
        },
        
        ////-----------------------------------------------------------------------------------------
        // Send a message to a contact
        send = function(outto, message) {
            var out = new xmpp.Element('message', {
                to: outto,
                type: 'chat'
            });
            
            var body = out.c('body');
            body.t(message);
            
            xmppServer.send(out);
        },
        
        ////-----------------------------------------------------------------------------------------
        // Authorize a contact
        subscribed = function(to) {
            var out = new xmpp.Element('presence', {
                to: to,
                from: config.jid,
                type: 'subscribed'
            });
            xmppServer.send(out);
            xmppServer.send(presence);
        },
        
        ////-----------------------------------------------------------------------------------------
        // Unautorhize a contact
        unsubscribed = function(to) {
            var out = new xmpp.Element('presence', {
                to: to,
                from: config.jid,
                type: 'unsubscribed'
            });
            xmppServer.send(out);     
            xmppServer.send(presence);
        },
                
        ////-----------------------------------------------------------------------------------------
        // Add a contact
        dosubscribe = function(to) {
            if( to !== undefined ) {
                var out = new xmpp.Element('presence', {
                    to: to,
                    type: 'subscribe'
                });
                xmppServer.send(out);
                xmppServer.send(presence);
            }
        },
        
        ////-----------------------------------------------------------------------------------------
        // Remove a contact
        dounsubscribe = function(to) {
            var out = new xmpp.Element('presence', {
                to: to,
                type: 'unsubscribe'
            });
            xmppServer.send(out);     
            xmppServer.send(presence);
        }

    ////=============================================================================================
    ;

    /////////////////////////////////////////////////////////////////////////////////////////////////

    init(_events, _config);
    
    /////////////////////////////////////////////////////////////////////////////////////////////////
}
