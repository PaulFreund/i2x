//###################################################################################################
// Basic Object
module.exports = (function xmppHandler() {
    /////////////////////////////////////////////////////////////////////////////////////////////////
   
    var 
    ////=============================================================================================
    // Requirements
        
        events = require('events'),
        xmpp = require('node-xmpp'),
    
    ////=============================================================================================
    // Propertys

        _emitter = new events.EventEmitter(),
        xmppServer,
        _host,
        _port,
        _jid,
        _password,
        presence, 
    
    ////=============================================================================================
    // Methods
    
        ////-----------------------------------------------------------------------------------------
        // Function
        init = function(host, port, jid, password) {        
            _host = host;
            _port = port;
            _jid = jid;
            _password = password;
            
            xmppServer = new xmpp.Client({jid:_jid,password:_password,host:_host,port:_port});

            xmppServer.on('online', onOnline);
            xmppServer.on('error', onError);       
            xmppServer.on('stanza', onStanza);
            
            presence = new xmpp.Element('presence', {});
        },
        
        onOnline = function() {
            //console.log('Client Online');
            xmppServer.send(presence.c('show').t('chat').up().c('status').t('Happily echoing your <message/> stanzas')
		 );
        },
        
        onError = function(error) {
            console.log('Error: '+error);
        },
        
        onStanza = function(stanza) {
            if(stanza.attrs.type === 'error')
                onError('Stanza Error');
            
            if (stanza.is('message'))
                onMessage(stanza);
        },
        
        onMessage = function(stanza) {
            var inmsg = stanza.children[0].children[0];
            _emitter.emit('message', stanza.attrs.from, stanza.attrs.to, inmsg);
        },
        
        send = function(message) {
            var out = new xmpp.Element('message', {
                to: 'bigwookie@saftsack.org',
                type: 'chat'
            });
            
            var body = out.c('body');
            body.t(message);
            
            xmppServer.send(out);
        }
        

    ////=============================================================================================
    ;

    /////////////////////////////////////////////////////////////////////////////////////////////////

    return {
        events:_emitter,
        init:init,
        send:send
    };
    
    /////////////////////////////////////////////////////////////////////////////////////////////////
}) ();
