//###################################################################################################
// IRC Handler
/*
    Events:
    
    - message   (from, to, message)                     : Simple text message
    - command   (from, to, message)                     : Messages that begin with !
    - event     (typ, channel, ...)                     : Server Events
        -names (... names )                             : Nicklist from the channel
        -topic (... topic, who )                        : Channel Topic
        -join  (... channel, nick )                     : Nick joined
        -part  (... channel, nick )                     : Nick parted
        -kick  (... channel, nick )                     : Nick kicked
        -nick  (... oldNick, newNick, channels )        : Nick joined
    
    Commands;
    
    - say       (to, message)                           : Send string to channel or person 
    - send      (to, args)                              : Not implemented yet
    
*/

//###################################################################################################
// Create Function

module.exports.create = function(_config) {
    return new Handler(_config);
};

//###################################################################################################
// Basic Object
function Handler(_config) {
    /////////////////////////////////////////////////////////////////////////////////////////////////
   
    var 
    ////=============================================================================================
    // Requirements
        
        irc = require('irc'),
    
    ////=============================================================================================
    // Propertys
    
        self = this,
        ircServer,
        config,
    
    ////=============================================================================================
    // Methods
    
        ////-----------------------------------------------------------------------------------------
        // Initialize
        init = function(_config) {
            
            if( _config !== undefined )
                config = _config;
            else
                console.error('[ircHandler] Options undefined');
            
            events.EventEmitter.call(this);
                        
            ircServer = new irc.Client(config.host, config.name, {channels: [config.channel]});

            // Events
            ircServer.addListener('message', onMessage);

            ircServer.addListener('names', function(channel, names) {
                self.emit('event','names', channel, names);
            });  
            
            ircServer.addListener('topic', function(channel,names) {
                self.emit('event','topic', channel, topic, nick);
            });

            ircServer.addListener('join', function(channel,nick) {
                self.emit('event','join', channel, nick);
            });

            ircServer.addListener('part', function(channel,nick) {
                self.emit('event','part', channel, nick);
            });
            
            ircServer.addListener('kick', function(channel,nick) {
                self.emit('event','kick', channel, nick);
            });

            ircServer.addListener('nick', function(oldnick,newnick, channels) {
                self.emit('event','nick', oldnick, newnick, channels);
            });

            // Actions
            self.on('send', send);
            self.on('say', say);
        },
        
        ////-----------------------------------------------------------------------------------------
        // A message from the server
        onMessage = function(from, to, message) {
            if( message.charAt(0) === '!')
                self.emit('command', from, to, command);
            else
                self.emit('message', from, to, message);
        },

        ////-----------------------------------------------------------------------------------------
        // Send a message to the recipient
        say = function(to, message) {
            ircServer.say(config.channel, message);   
        },
        
        ////-----------------------------------------------------------------------------------------
        // Send an IRC Command
        send = function(to, args) { 
            var arr = [];
            ircServer.send.apply(this, arr.concat(to, args));
            
        }
        

    ////=============================================================================================
    ;

    /////////////////////////////////////////////////////////////////////////////////////////////////

    init(_config);
    
    /////////////////////////////////////////////////////////////////////////////////////////////////
}

//###################################################################################################
// Inherit from EventEmitter

events = require('events');
Handler.super_ = events.EventEmitter;
Handler.prototype = Object.create(events.EventEmitter.prototype, {
    constructor: {
        value: Handler,
        enumerable: false
    }   
});
